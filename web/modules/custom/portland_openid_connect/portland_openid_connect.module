<?php

use Drupal\user\Entity\User;
use Drupal\Core\Language\LanguageInterface;
use GuzzleHttp\Exception\RequestException;


/**
 * Implement hook_cron()
 * Retrieve a view and send it to powr@portlandoregon.gov
 */
function portland_openid_connect_cron()
{

  // DELETE FROM semaphore WHERE name = 'cron';

  // Call Microsoft Graph API to retrieve user info
  $tokens = _get_access_token();
  if(empty($tokens['access_token'])) return;

  _get_all_users($tokens['access_token']);
}


function _add_users($response_data) {
  $user_data_array = $response_data['value']; // array of users
  if(empty($user_data_array)) return;

  foreach($user_data_array as $user_data) {
    // Skip accounts without first or last names
    if(empty($user_data['givenName']) || 
      empty($user_data['surname']) || 
      empty($user_data['mail']))
      continue;

    $users = \Drupal::entityTypeManager()
      ->getStorage('user')
      ->loadByProperties(['field_active_directory_id' => $user_data['id']]);
    
    if(count($users) == 0) {
      $user = User::create([
        'name' => $user_data['id'], //$user_data['givenName'] . ' ' . $user_data['surname'],
        'mail' => $user_data['mail'],
        'pass' => user_password(),
        'status' => 1,
        'field_active_directory_id' => $user_data['id'],
        'field_first_name' => $user_data['givenName'],
        'field_last_name' => $user_data['surname'],
      ]);
    }
    else {
      $user = array_values($users)[0];
      $user->set('name', $user_data['id']);
      $user->set('mail', $user_data['mail']);
      $user->set('field_active_directory_id', $user_data['id']);
      $user->set('field_first_name', $user_data['givenName']);
      $user->set('field_last_name', $user_data['surname']);
    }
    $user -> save();
  }
}

function _get_all_users($access_token) {

  $system_state = \Drupal::state();

  /* @var \GuzzleHttp\ClientInterface $client */
  $client = new \GuzzleHttp\Client();
  // Perform the request.
  $options = [
    'method' => 'GET',
    'headers' => [
      'Content-Type' => 'application/json',
      'Authorization' => 'Bearer ' . $access_token,
    ],
  ];

  try { 
    $deltaLink = $system_state->get('deltaLink');

    // For debug
    $deltaLink = '';

    $request_url = (empty($deltaLink)) ? 'https://graph.microsoft.com/v1.0/users/delta' : $deltaLink;
    $response = $client->get($request_url, $options);
    $response_data = json_decode((string) $response->getBody(), TRUE);
    _add_users($response_data);

    // Loop until there is no nextLink
    $next_request_url = $response_data['@odata.nextLink'];
    while($next_request_url != null) {
      $response = $client->get($next_request_url, $options);
      $response_data = json_decode((string) $response->getBody(), TRUE);
      $next_request_url = $response_data['@odata.nextLink'];
      _add_users($response_data);
    }

    $system_state->set('deltaLink', $response_data['@odata.deltaLink']);

    return true;
  }
  catch (RequestException $e) {
    $variables = [
      '@message' => 'Could not retrieve tokens',
      '@error_message' => $e->getMessage(),
    ];
    // $this->loggerFactory->get('openid_connect_windows_aad')
      // ->error('@message. Details: @error_message', $variables);
    return FALSE;
  }
}

function _get_access_token() {
  $windows_aad_config = \Drupal::config('openid_connect.settings.windows_aad');

  $request_options = [
    'form_params' => [
      // 'code' => $authorization_code,
      'client_id' => $windows_aad_config->get('settings.client_id'),
      'client_secret' => $windows_aad_config->get('settings.client_secret'),
      'grant_type' => 'client_credentials',
      'scope' => 'https://graph.microsoft.com/.default',
    ],
  ];

  /* @var \GuzzleHttp\ClientInterface $client */
  $client = new \GuzzleHttp\Client();

  try {
    $response = $client->post('https://login.microsoftonline.com/636d7808-73c9-41a7-97aa-8c4733642141/oauth2/v2.0/token', $request_options);
    $response_data = json_decode((string) $response->getBody(), TRUE);

    // Expected result.
    $tokens = [
      // 'id_token' => $response_data['id_token'],
      'access_token' => $response_data['access_token'],
    ];
    if (array_key_exists('expires_in', $response_data)) {
      $tokens['expire'] = \Drupal::time()->getRequestTime() + $response_data['expires_in'];
    }
    return $tokens;
  }
  catch (RequestException $e) {
    $variables = [
      '@message' => 'Could not retrieve tokens',
      '@error_message' => $e->getMessage(),
    ];
    // $this->loggerFactory->get('openid_connect_windows_aad')
      // ->error('@message. Details: @error_message', $variables);
    return FALSE;
  }
}