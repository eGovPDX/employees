# Behat testing
## Drupal interaction
This implementation runs again a multidev instance of the site on Pantheon, and almost all of the features need to run from a terminus authorized machine.
## Configuration
### behat.yml
This file holds all the configuration run during a CircleCI build.
#### Interaction with CircleCI
Circle CI uses some environment variables to add configuration, and the behat.yml file will override that configuration, so be sure to check the CircleCI configiuration before you check in configuration changes to behat.
## Helpful resources
### [Mink context source](https://github.com/Behat/MinkExtension/blob/master/src/Behat/MinkExtension/Context/MinkContext.php)
Use this to see what Gherkin commands you can use with Mink by default.
### [Behat documentation](http://docs.behat.org/en/latest/)
Careful with Google, it loves the 2.5 documentation which is not accurate for the 3.x version we currently use.
 # Visual Regression
## Installing dependencies
Run one-time setup to install dependencies
```
lando rebuild -y
```
## Intro
The test code is written in JavaScript and relies on Puppeteer to interact with the browser and Jest to validate test result and run tests. In CI environment, it also uses Percy to capture and analyse visual differences. It's recommended to learn about [Puppeteer](https://developers.google.com/web/tools/puppeteer/get-started) and [Jest](https://jestjs.io/docs/getting-started) before writing tests.

Tests available:
- `admin`

`admin.js` contains essential tests that must be run during each build.

IMPORTANT: Tests **must** be independent and have no side effect in other tests.

### Add visual_regression test
To add new test:
1. Identify which user the test should run as.
2. Edit the test file. Copy an existing test `it()` and modify the test code inside `async () => {...}`

## Debugging tips
Jest allows users to include or exclude tests. To only run certain test, use `it.only`. To exclude a test, use `it.skip`.

In order to help diagnose a failed test, all test code is wrapped inside try-catch blocks which generates a screenshot when an assertion fails or an exception is thrown.

If the screenshots generated by failed test do not help to diagonose the problem, you may need to consult the [official Puppeteer debugging tips](https://developers.google.com/web/tools/puppeteer/debugging) in order to step through your code.